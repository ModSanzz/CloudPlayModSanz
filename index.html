<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DPMods Full Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --primary:#C77DFF;
  --bg:#121212;
  --card:#1e1e1e;
  --text:#fff;
  --muted:#aaa;
  --danger:#ff4d4d;
  --glow:0 0 8px rgba(199,125,255,.7),0 0 15px rgba(199,125,255,.3);
}
body{margin:0;font-family:Roboto;background:var(--bg);color:var(--text);padding-bottom:80px;}
header{padding:15px;text-align:center;background:#1a1a1a;box-shadow:0 2px 5px rgba(0,0,0,.5);}
h1{margin:0;color:var(--primary);}
.container{padding:15px;max-width:900px;margin:auto;}
input,textarea,select{width:100%;padding:8px;margin-top:5px;border-radius:6px;background:#333;border:1px solid #555;color:#fff;}
button{cursor:pointer;border:none;border-radius:6px;padding:8px 12px;font-weight:700;}
.btn-primary{background:var(--primary);color:#000;}
.btn-danger{background:var(--danger);color:#fff;}
.user{background:var(--card);padding:15px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.user.valid{border-left:4px solid var(--primary);}
.user.expired{border-left:4px solid var(--danger);}
small{color:var(--muted);}
.search{display:flex;gap:10px;margin-bottom:10px;}
nav{position:fixed;bottom:0;left:0;right:0;height:60px;background:#1a1a1a;display:flex;justify-content:space-around;align-items:center;}
nav div{text-align:center;color:var(--muted);cursor:pointer;}
nav .active{color:var(--primary);}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;}
.modal-box{background:var(--card);padding:20px;border-radius:10px;width:90%;max-width:420px;}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#000;padding:10px 20px;border-radius:20px;display:none;}
.date-shortcuts{display:flex;gap:5px;margin-bottom:10px;}
.date-shortcuts button{background:#333;color:#fff;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;flex-shrink:0;}
.date-shortcuts button:hover{background:#444;}
</style>
</head>
<body>

<header><h1>DPMods Admin Panel</h1></header>

<div class="container" id="usersTab">
  <div class="search">
    <input id="searchInput" placeholder="Cari Build ID..." oninput="render()">
    <select id="filter" onchange="render()">
      <option value="all">Semua</option>
      <option value="valid">Aktif</option>
      <option value="expired">Kadaluarsa</option>
    </select>
    <button class="btn-primary" onclick="openModal()">Tambah ID</button>
  </div>
  <div id="list"></div>

  <div style="margin-top:10px;">
    <button class="btn-primary" onclick="exportJSON()">Export JSON</button>
    <button class="btn-primary" onclick="exportCSV()">Export CSV</button>
  </div>
</div>

<div class="container" id="settingsTab" style="display:none">
  <h3>Maintenance</h3>
  <label><input type="checkbox" id="mnt"> Aktifkan Maintenance</label>
  <textarea id="mntMsg" placeholder="Pesan maintenance"></textarea>
  <button class="btn-primary" onclick="saveMaintenance()">Simpan Maintenance</button>
</div>

<nav>
  <div id="navUsers" class="active" onclick="showTab('users')"><i class="fa fa-key"></i><br>ID</div>
  <div id="navSettings" onclick="showTab('settings')"><i class="fa fa-bell"></i><br>Status</div>
</nav>

<div class="modal" id="modal">
  <div class="modal-box">
    <h3>Tambah / Edit ID</h3>
    <input id="idInput" placeholder="Build ID">
    <input id="userInput" placeholder="Username">
    <label>Tanggal Kadaluarsa</label>
    <div class="date-shortcuts">
      <button onclick="setExpiry(1)">+1 Hari</button>
      <button onclick="setExpiry(7)">+7 Hari</button>
      <button onclick="setExpiry(30)">+30 Hari</button>
      <button onclick="setExpiry(90)">+3 Bulan</button>
      <button onclick="setExpiry(365)">+1 Tahun</button>
    </div>
    <input type="date" id="dateInput">
    <br><br>
    <button class="btn-primary" onclick="saveID()">Simpan</button>
    <button class="btn-danger" onclick="closeModal()">Batal</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const FIREBASE_ROOT = "https://cloudplaypaneladmin-default-rtdb.asia-southeast1.firebasedatabase.app";
const KEYS_URL = FIREBASE_ROOT + "/keys.json";

let data = {};
let editId = null;

const $ = id=>document.getElementById(id);

function toast(msg){
  const t=$('toast'); t.innerText=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none',2500);
}

async function load(){
  const r = await fetch(KEYS_URL);
  data = await r.json() || {};
  render();
  if(data.MAINTENANCE){
    $('mnt').checked = data.MAINTENANCE.status==="active";
    $('mntMsg').value = data.MAINTENANCE.message||"";
  }
}

function render(){
  const list=$('list');
  list.innerHTML='';
  const q=$('searchInput').value.toLowerCase();
  const f=$('filter').value;
  Object.keys(data).forEach(id=>{
    if(id==="MAINTENANCE") return;
    const d=data[id];
    const expired = isExpired(d.date);
    if(f==="valid" && expired) return;
    if(f==="expired" && !expired) return;
    if(q && !id.toLowerCase().includes(q)) return;
    list.innerHTML+=`<div class="user ${expired?'expired':'valid'}">
      <div><strong>${id}</strong> <br><small>${d.username||'-'} | Expire: ${d.date||'-'}</small></div>
      <div>
        <button onclick="edit('${id}')">‚úèÔ∏è</button>
        <button onclick="del('${id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  });
}

function isExpired(date){
  if(!date) return true;
  const today=new Date(); today.setHours(0,0,0,0);
  return new Date(date)<today;
}

function showTab(t){
  $('usersTab').style.display=t==='users'?'block':'none';
  $('settingsTab').style.display=t==='settings'?'block':'none';
  $('navUsers').classList.toggle('active',t==='users');
  $('navSettings').classList.toggle('active',t==='settings');
}

function openModal(){
  editId=null;
  $('idInput').value='';
  $('userInput').value='';
  $('dateInput').value='';
  $('modal').style.display='flex';
}

function closeModal(){ $('modal').style.display='none'; }

function setExpiry(days){
  const d=new Date();
  d.setDate(d.getDate()+days);
  $('dateInput').value=d.toISOString().split('T')[0];
}

function edit(id){
  editId=id;
  $('idInput').value=id;
  $('userInput').value=data[id].username||'';
  $('dateInput').value=data[id].date||'';
  $('modal').style.display='flex';
}

async function saveID(){
  const id=$('idInput').value.trim();
  const user=$('userInput').value.trim();
  const date=$('dateInput').value;
  if(!id||!date||!user){toast("ISI SEMUA!");return;}
  data[id]={username:user,date:date,status:"active"};
  await fetch(KEYS_URL,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({[id]:data[id]})});
  load();
  closeModal();
  toast("Tersimpan");
}

async function del(id){
  if(confirm("Hapus "+id+" ?")){
    await fetch(KEYS_URL,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({[id]:null})});
    load();
    toast("Dihapus");
  }
}

async function saveMaintenance(){
  const status=$('mnt').checked?'active':'inactive';
  const msg=$('mntMsg').value;
  await fetch(KEYS_URL,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({MAINTENANCE:{status,msg}})});
  toast("Maintenance disimpan");
}

function exportJSON(){
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='backup_keys.json'; a.click(); URL.revokeObjectURL(url);
  toast('Data diekspor JSON');
}

function exportCSV(){
  const arr=Object.keys(data).filter(k=>k!=='MAINTENANCE').map(k=>[k,data[k].username||'',data[k].date||'',data[k].status||''].join(','));
  const csv=['build_id,username,date,status',...arr].join('\r\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='backup_keys.csv'; a.click(); URL.revokeObjectURL(url);
  toast('Data diekspor CSV');
}

load();
</script>
</body>
</html>

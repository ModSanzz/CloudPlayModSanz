<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CloudPlay Admin Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --primary:#C77DFF;--card:#282828;--bg:#121212;--text:#fff;
  --muted:#aaa;--danger:#ff4d4d;
}
body{margin:0;font-family:Roboto;background:var(--bg);color:var(--text);padding-bottom:70px}
header{background:var(--card);padding:15px;text-align:center}
h1{margin:0;color:var(--primary)}
.container{max-width:900px;margin:auto;padding:20px}
.search-bar{display:flex;gap:8px;margin-bottom:15px}
.search-bar input{flex:1;padding:10px;background:#333;color:#fff;border:1px solid #444;border-radius:6px}
.search-bar button{background:var(--primary);border:none;border-radius:6px;padding:10px 14px;cursor:pointer}
.filter-bar{display:flex;gap:10px;margin-bottom:15px}
.filter-bar button{background:#333;border:none;padding:6px 14px;border-radius:20px;color:var(--muted);cursor:pointer}
.filter-bar button.active{background:var(--primary);color:#000}

.user-item{background:var(--card);padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;border-left:5px solid}
.user-item.valid{border-color:var(--primary)}
.user-item.expired{border-color:var(--danger);background:#331f1f}
.user-status{font-size:12px;font-weight:700;margin-right:10px}
.valid .user-status{color:var(--primary)}
.expired .user-status{color:var(--danger)}

.user-actions button{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer}
.user-actions .delete{color:var(--danger)}

nav{position:fixed;bottom:0;left:0;right:0;height:60px;background:var(--card);display:flex;justify-content:space-around;align-items:center}
.nav-item{color:var(--muted);cursor:pointer}
.nav-item.active{color:var(--primary)}
.add-btn{width:56px;height:56px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:24px;color:#000;transform:translateY(-15px)}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center}
.modal-content{background:var(--card);padding:20px;border-radius:12px;width:90%;max-width:420px}
input,textarea{width:100%;padding:10px;background:#333;border:1px solid #444;color:#fff;border-radius:6px}

.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#000;padding:10px 20px;border-radius:20px;opacity:0;transition:.3s}
.toast.show{opacity:1}
</style>
</head>

<body>

<header><h1>CloudPlay Admin Panel</h1></header>

<div class="container">
  <div id="usersTab">
    <div class="search-bar">
      <input id="searchInput" placeholder="Cari Build ID">
      <button onclick="render()">üîç</button>
    </div>

    <div class="filter-bar">
      <button class="active" onclick="setFilter('all',this)">ALL</button>
      <button onclick="setFilter('valid',this)">VALID</button>
      <button onclick="setFilter('expired',this)">EXPIRED</button>
    </div>

    <div id="list"></div>
  </div>

  <div id="settingsTab" style="display:none">
    <h3>Maintenance</h3>
    <label>
      <input type="checkbox" id="mntToggle"> Maintenance ON
    </label>
    <textarea id="mntMsg" placeholder="Pesan maintenance"></textarea>
    <button onclick="saveMaintenance()">Simpan</button>
  </div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Add ID</h3>
    <input id="buildInput" placeholder="Build ID">
    <input id="userInput" placeholder="User">
    <div style="display:flex;gap:5px;margin:5px 0">
      <button onclick="addDays(1)">+1</button>
      <button onclick="addDays(7)">+7</button>
      <button onclick="addDays(30)">+30</button>
    </div>
    <input type="date" id="dateInput">
    <button onclick="save()">Simpan</button>
    <button onclick="closeModal()">Batal</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<nav>
  <div class="nav-item active" onclick="tab('users')">IDs</div>
  <div class="add-btn" onclick="openAdd()">+</div>
  <div class="nav-item" onclick="tab('settings')">Status</div>
</nav>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCJ3srzZMnhN4ngShr2b0iI7KEsLespNZg",
  authDomain: "cloudplayadmin.firebaseapp.com",
  databaseURL: "https://cloudplayadmin-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "cloudplayadmin",
  storageBucket: "cloudplayadmin.firebasestorage.app",
  messagingSenderId: "747853876510",
  appId: "1:747853876510:web:d11428bc7c0716a038cd0f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let data={}, filter="all", editKey=null;

const expired = d => !d || new Date(d) < new Date().setHours(0,0,0,0);
const toast = m => {toastEl.textContent=m;toastEl.classList.add("show");setTimeout(()=>toastEl.classList.remove("show"),2500)}
const toastEl = document.getElementById("toast");

onAuthStateChanged(auth,user=>{
  if(!user){location.href="login.html";return;}
  onValue(ref(db,"keys"),snap=>{data=snap.val()||{};render();});
  onValue(ref(db,"maintenance"),snap=>{
    const m=snap.val()||{};
    mntToggle.checked=m.status==="active";
    mntMsg.value=m.message||"";
  });
});

window.render=()=>{
  list.innerHTML="";
  Object.entries(data).forEach(([k,v])=>{
    const isExp=expired(v.date);
    if(filter==="valid" && isExp) return;
    if(filter==="expired" && !isExp) return;
    if(searchInput.value && !k.toLowerCase().includes(searchInput.value.toLowerCase())) return;

    list.innerHTML+=`
    <div class="user-item ${isExp?'expired':'valid'}">
      <div>
        <div class="user-status">${isExp?'EXPIRED':'VALID'}</div>
        <b>${k}</b><br>
        ${v.user||''}<br>
        ${v.date||'-'}
      </div>
      <div class="user-actions">
        <button onclick="edit('${k}')"><i class="fa fa-edit"></i></button>
        <button class="delete" onclick="del('${k}')"><i class="fa fa-trash"></i></button>
      </div>
    </div>`;
  });
};

window.openAdd=()=>{editKey=null;modal.style.display="flex";};
window.closeModal=()=>modal.style.display="none";
window.addDays=d=>{const t=new Date();t.setDate(t.getDate()+d);dateInput.value=t.toISOString().split("T")[0];};

window.save=()=>{
  const k=buildInput.value.trim();
  if(!k)return;
  set(ref(db,"keys/"+k),{user:userInput.value,date:dateInput.value});
  closeModal();toast("Disimpan");
};

window.edit=k=>{
  editKey=k;
  buildInput.value=k;
  userInput.value=data[k].user||"";
  dateInput.value=data[k].date||"";
  modal.style.display="flex";
};

window.del=k=>{
  if(confirm("Hapus "+k+" ?")){
    remove(ref(db,"keys/"+k));
    toast("Dihapus");
  }
};

window.saveMaintenance=()=>{
  set(ref(db,"maintenance"),{
    status:mntToggle.checked?"active":"inactive",
    message:mntMsg.value
  });
  toast("Maintenance updated");
};

window.setFilter=(f,el)=>{
  filter=f;
  document.querySelectorAll(".filter-bar button").forEach(b=>b.classList.remove("active"));
  el.classList.add("active");
  render();
};

window.tab=t=>{
  usersTab.style.display=t==="users"?"block":"none";
  settingsTab.style.display=t==="settings"?"block":"none";
};
</script>

</body>
</html>
